name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  # Run weekly on Sundays at 00:00 UTC even if no PRs/pushes
  schedule:
    - cron: '0 0 * * 0'
  # Allow manual triggering
  workflow_dispatch:

jobs:
  test:
    name: Test
    strategy:
      fail-fast: false
      matrix:
        # Only ubuntu for regular CI, full matrix for PRs/releases
        os: ${{ (github.event_name == 'pull_request' || startsWith(github.ref, 'refs/tags/')) && fromJSON('["ubuntu-latest", "macos-latest", "windows-latest"]') || fromJSON('["ubuntu-latest"]') }}
        go-version: ['1.24']
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5
        with:
          go-version: ${{ matrix.go-version }}
          cache: true

      - name: Check formatting
        if: runner.os != 'Windows'
        run: |
          fmt_output=$(gofmt -l .)
          if [ -n "$fmt_output" ]; then
            echo "❌ Go files need formatting:"
            echo "$fmt_output"
            exit 1
          fi
          echo "✅ All files properly formatted"

      - name: Go vet
        run: go vet ./...

      - name: Run tests
        shell: bash
        run: |
          mkdir -p .coverage
          go test -v -race -coverprofile=.coverage/profile.out -covermode=atomic ./...

      - name: Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@b9fd7d16f6d7d1b5d2bec1a2887e65ceed900238 # v4
        with:
          file: ./.coverage/profile.out
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  lint:
    name: Lint
    runs-on: ubuntu-slim
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5
        with:
          go-version: '1.24'
          cache: true

      - name: golangci-lint
        uses: golangci/golangci-lint-action@55c2c1448f86e01eaae002a5a3a9624417608d84 # v6
        with:
          version: latest
          args: --timeout=5m

  build:
    name: Build
    strategy:
      fail-fast: false
      matrix:
        # Only ubuntu for regular CI, full matrix for PRs/releases
        os: ${{ (github.event_name == 'pull_request' || startsWith(github.ref, 'refs/tags/')) && fromJSON('["ubuntu-latest", "macos-latest", "windows-latest"]') || fromJSON('["ubuntu-latest"]') }}
        go-version: ['1.24']
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5
        with:
          go-version: ${{ matrix.go-version }}
          cache: true

      - name: Build
        run: go build -v ./...

      - name: Build CLI binary
        run: |
          go build -o tempus${{ runner.os == 'Windows' && '.exe' || '' }} .

      - name: Test CLI execution
        if: runner.os != 'Windows'
        run: |
          ./tempus --version || ./tempus --help

  functional-tests:
    name: Functional Tests
    if: always()
    needs: [test, lint, build]
    runs-on: ubuntu-slim
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5
        with:
          go-version: '1.24'
          cache: true

      - name: Build binary
        run: go build -o tempus .

      - name: Test basic commands
        run: |
          echo "✅ Testing --help"
          ./tempus --help

          echo "✅ Testing --version"
          ./tempus --version || true

          echo "✅ Testing config commands"
          ./tempus config list

          echo "✅ Testing template list"
          ./tempus template list

          echo "✅ Testing template describe"
          ./tempus template describe medical

      - name: Test event creation
        run: |
          echo "✅ Testing create command"
          ./tempus create "Test Event" \
            --start "2025-12-20 14:00" \
            --duration "1h" \
            --start-tz "Europe/Madrid" \
            --output /tmp/test-event.ics

          echo "✅ Verifying ICS file was created"
          test -f /tmp/test-event.ics || exit 1

          echo "✅ Checking ICS content"
          grep "BEGIN:VCALENDAR" /tmp/test-event.ics
          grep "Test Event" /tmp/test-event.ics

      - name: Test batch mode
        run: |
          echo "✅ Testing batch CSV"
          cat > /tmp/test-batch.csv << 'EOF'
          summary,start,duration,start_tz,categories
          Morning medication,2025-12-20 08:00,5m,Europe/Madrid,medication
          Team meeting,2025-12-20 10:00,1h,Europe/Madrid,work
          EOF

          ./tempus batch \
            --input /tmp/test-batch.csv \
            --output /tmp/test-batch.ics \
            --name "Test Batch"

          echo "✅ Verifying batch ICS was created"
          test -f /tmp/test-batch.ics || exit 1

          echo "✅ Checking batch ICS has 2 events"
          count=$(grep -c "BEGIN:VEVENT" /tmp/test-batch.ics)
          if [ "$count" != "2" ]; then
            echo "❌ Expected 2 events, got $count"
            exit 1
          fi

      - name: Test dry-run mode
        run: |
          echo "✅ Testing dry-run mode"
          ./tempus batch \
            --input /tmp/test-batch.csv \
            --dry-run

      - name: Test conflict detection
        run: |
          echo "✅ Testing conflict detection"
          cat > /tmp/test-conflicts.csv << 'EOF'
          summary,start,duration,start_tz,categories
          Event 1,2025-12-20 09:00,2h,Europe/Madrid,work
          Event 2,2025-12-20 10:00,1h,Europe/Madrid,work
          EOF

          ./tempus batch \
            --input /tmp/test-conflicts.csv \
            --output /tmp/test-conflicts.ics \
            --check-conflicts || true

      - name: Test timezone commands
        run: |
          echo "✅ Testing timezone list"
          ./tempus timezone list --country Spain

          echo "✅ Testing timezone info"
          ./tempus timezone info Europe/Madrid

      - name: Test alarm profiles
        run: |
          echo "✅ Testing alarm profiles"
          ./tempus config alarm-profiles

      - name: Test RRULE helper
        run: |
          echo "✅ Testing RRULE command exists"
          ./tempus rrule --help || ./tempus --help | grep -i rrule || true

  coverage-check:
    name: Coverage Check
    if: always()
    needs: test
    runs-on: ubuntu-slim
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5
        with:
          go-version: '1.24'
          cache: true

      - name: Generate coverage report
        run: |
          mkdir -p .coverage
          go test -v -coverprofile=.coverage/profile.out -covermode=atomic ./...
          go tool cover -func=.coverage/profile.out > coverage.txt

      - name: Check coverage threshold
        run: |
          total_coverage=$(go tool cover -func=.coverage/profile.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Total coverage: ${total_coverage}%"

          # Target: 75% minimum coverage
          threshold=75
          if (( $(echo "$total_coverage < $threshold" | bc -l) )); then
            echo "❌ Coverage ${total_coverage}% is below threshold ${threshold}%"
            exit 1
          fi
          echo "✅ Coverage ${total_coverage}% meets threshold ${threshold}%"

      - name: Upload coverage report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: coverage-report
          path: coverage.txt
