name: Sync Branches

on:
  push:
    branches:
      - develop
      - main

jobs:
  sync:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main')

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync main to develop
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout develop
          git merge --ff-only origin/main || {
            echo "Fast-forward merge failed. Manual intervention required."
            exit 1
          }
          git push origin develop

      - name: Auto-promote develop to main
        if: |
          github.ref == 'refs/heads/develop' &&
          (
            startsWith(github.event.head_commit.message, 'chore(deps):') ||
            startsWith(github.event.head_commit.message, 'fix(deps):') ||
            github.event.head_commit.author.name == 'renovate[bot]' ||
            github.event.head_commit.author.name == 'dependabot[bot]'
          )
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout main
          git merge --ff-only origin/develop || {
            echo "Fast-forward merge failed. Manual intervention required."
            exit 1
          }
          git push origin main
